<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨çƒè§†è§’ | è·¨è¯­è¨€è¯„è®ºå¯¹æ¯”</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Source+Serif+4:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --ink: #0b0b0c;
      --muted: #595b60;
      --paper: #f6f6f4;
      --panel: #ffffff;
      --line: #d8d8d6;
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Source Serif 4", "Noto Serif SC", "Songti SC", serif;
      color: var(--ink);
      background: radial-gradient(circle at top right, rgba(0, 0, 0, 0.06), transparent 45%),
        linear-gradient(180deg, #f8f8f6 0%, #f2f2ee 100%);
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(transparent 23px, rgba(0, 0, 0, 0.04) 24px),
        linear-gradient(90deg, transparent 23px, rgba(0, 0, 0, 0.04) 24px);
      background-size: 24px 24px;
      opacity: 0.25;
      z-index: 0;
    }

    #app {
      position: relative;
      z-index: 1;
      max-width: 1180px;
      margin: 0 auto;
      padding: 72px 24px 96px;
      display: flex;
      flex-direction: column;
      gap: 48px;
    }

    .brand {
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.4em;
      font-size: 12px;
      color: var(--muted);
    }

    .hero {
      display: grid;
      gap: 28px;
      animation: fadeIn 0.7s ease;
    }

    .hero h1 {
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
      font-size: clamp(34px, 5vw, 56px);
      line-height: 1.05;
      letter-spacing: -0.02em;
    }

    .hero p {
      max-width: 640px;
      color: var(--muted);
      font-size: 16px;
      line-height: 1.7;
    }

    .search-box {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px;
      box-shadow: var(--shadow);
    }

    .search-box input {
      border: none;
      outline: none;
      background: transparent;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .search-box button {
      border: none;
      background: #0b0b0c;
      color: #fff;
      font-weight: 700;
      padding: 12px 26px;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .search-box button:hover {
      transform: translateY(-1px);
    }

    .assist {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .assist span {
      border: 1px solid var(--line);
      padding: 6px 12px;
      border-radius: 999px;
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .results {
      display: none;
      flex-direction: column;
      gap: 36px;
      animation: fadeIn 0.6s ease;
    }

    .results.active {
      display: flex;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .query-card {
      background: var(--panel);
      border: 1px solid var(--line);
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: var(--shadow);
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .ghost-btn {
      border: 1px solid var(--line);
      background: transparent;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
      transition: all 0.2s ease;
    }

    .ghost-btn:hover {
      border-color: var(--ink);
      color: var(--ink);
    }

    .module {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .module-title {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .module-title h2 {
      font-size: 26px;
    }

    .module-header p {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .module-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .primary-btn {
      border: none;
      background: #0b0b0c;
      color: #fff;
      font-weight: 700;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status-pill {
      font-size: 12px;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
    }

    .status-pill.ready {
      border-color: #0b0b0c;
      color: #0b0b0c;
    }

    .summary-panel {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      background: #fdfdfc;
      display: none;
    }

    .summary-panel.active {
      display: block;
    }

    .summary-panel h3 {
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
      font-size: 18px;
      margin-bottom: 8px;
    }

    .summary-panel p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.7;
      margin-bottom: 8px;
    }

    .pager {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 16px;
      border: 1px solid var(--line);
      border-radius: 999px;
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .pager-info {
      font-size: 13px;
      color: var(--muted);
    }

    .pager-dots {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .pager-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      cursor: pointer;
    }

    .pager-dot.active {
      background: #0b0b0c;
      border-color: #0b0b0c;
    }

    .language-page {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 16px;
      animation: fadeIn 0.4s ease;
    }

    .lang-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .lang-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .tag {
      font-size: 11px;
      font-weight: 700;
      border: 1px solid var(--line);
      padding: 4px 8px;
      border-radius: 999px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .lang-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .video-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    details {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
    }

    summary {
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
      font-weight: 600;
      cursor: pointer;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .video-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .comment-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }

    .comment {
      border-top: 1px dashed var(--line);
      padding-top: 10px;
      display: grid;
      gap: 6px;
    }

    .comment:first-child {
      border-top: none;
      padding-top: 0;
    }

    .comment .original {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.6;
    }

    .comment .translated {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .comment .likes {
      font-size: 11px;
      color: var(--muted);
      font-family: "Space Grotesk", "PingFang SC", sans-serif;
    }

    .error-box {
      background: rgba(0, 0, 0, 0.04);
      color: #8a2d2d;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
    }

    .skeleton {
      background: linear-gradient(90deg, #f2f2f2, #e5e5e5, #f2f2f2);
      background-size: 200% 100%;
      animation: shimmer 1.6s infinite;
      border-radius: 8px;
      height: 12px;
    }

    .skeleton-block {
      height: 140px;
    }

    .footnote {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 24px;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 720px) {
      .search-box {
        grid-template-columns: 1fr;
        border-radius: 20px;
        padding: 12px;
      }

      .search-box button {
        width: 100%;
      }

      .module {
        padding: 20px;
      }

      .results-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <section class="hero" id="home">
      <div class="brand">Global Perspective Engine</div>
      <h1>å•ä¸€è¾“å…¥ï¼Œå…¨çƒè¯„è®ºå¯¹ç…§ã€‚</h1>
      <p>
        è¾“å…¥äº‹ä»¶å…³é”®è¯ï¼Œç³»ç»Ÿå¹¶è¡ŒæŠ“å–å¤šè¯­è¨€ YouTube è¯„è®ºï¼Œè‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡å¹¶ç”Ÿæˆæ€»ç»“ï¼Œå¸®åŠ©ä½ å¿«é€ŸæŠŠæ¡å…¨çƒè§‚ç‚¹å·®å¼‚ã€‚
      </p>
      <div class="search-box">
        <input id="searchInput" type="text" placeholder="ä¾‹å¦‚ï¼šä¹ è¿‘å¹³" value="ä¹ è¿‘å¹³" />
        <button id="searchBtn">å¼€å§‹å¯¹æ¯”</button>
      </div>
      <div class="assist">
        <span>ä¸­æ–‡</span>
        <span>English</span>
        <span>æ—¥æœ¬èª</span>
        <span>Deutsch</span>
        <span>FranÃ§ais</span>
        <span>EspaÃ±ol</span>
        <span>PortuguÃªs</span>
      </div>
    </section>

    <section class="results" id="results">
      <div class="results-header">
        <div class="query-card">äº‹ä»¶å…³é”®è¯ï¼š<span id="queryText">-</span></div>
        <button class="ghost-btn" id="resetBtn">é‡æ–°æœç´¢</button>
      </div>

      <div class="module" id="videoModule">
        <div class="module-header">
          <div class="module-title">
            <h2>å¤šè¯­è¨€è§†é¢‘è¯„è®ºåˆ†æ</h2>
            <span class="status-pill" id="videoStatus">ç­‰å¾…æ£€ç´¢</span>
          </div>
          <p>æ¯ç§è¯­è¨€é€‰å–å‰ 10 ä¸ªè§†é¢‘ï¼Œæ¯ä¸ªè§†é¢‘å– 5 æ¡é«˜èµè¯„è®ºï¼Œå¹¶è¿›è¡Œç¿»è¯‘ä¸æ€»ç»“ã€‚</p>
          <div class="module-actions">
            <button class="primary-btn" id="globalSummaryBtn" disabled>ç”Ÿæˆå…¨çƒæ€»ç»“</button>
          </div>
        </div>

        <div class="pager">
          <button class="ghost-btn" id="prevLang">ä¸Šä¸€é¡µ</button>
          <div class="pager-info" id="pagerInfo">-</div>
          <button class="ghost-btn" id="nextLang">ä¸‹ä¸€é¡µ</button>
        </div>
        <div class="pager-dots" id="pagerDots"></div>

        <div class="summary-panel" id="globalSummary"></div>

        <div id="languagePage"></div>
      </div>

      <div class="footnote">è¯„è®ºæŠ½æ ·ä¸è¿‡æ»¤å¯è°ƒæ•´ï¼Œé€‚ç”¨äºå•†ä¸šçº§è·¨è¯­è¨€èˆ†æƒ…è§‚å¯Ÿã€‚</div>
    </section>
  </div>

  <script>
    const state = {
      query: "",
      items: [],
      currentIndex: 0,
    };

    const homeEl = document.getElementById("home");
    const resultsEl = document.getElementById("results");
    const queryTextEl = document.getElementById("queryText");
    const searchInput = document.getElementById("searchInput");
    const videoStatusEl = document.getElementById("videoStatus");
    const pagerInfoEl = document.getElementById("pagerInfo");
    const pagerDotsEl = document.getElementById("pagerDots");
    const languagePageEl = document.getElementById("languagePage");
    const globalSummaryBtn = document.getElementById("globalSummaryBtn");
    const globalSummaryEl = document.getElementById("globalSummary");

    function renderSkeleton() {
      languagePageEl.innerHTML = `
        <div class="language-page">
          <div class="skeleton" style="width: 120px;"></div>
          <div class="skeleton" style="width: 70%;"></div>
          <div class="skeleton" style="width: 55%;"></div>
          <div class="skeleton skeleton-block"></div>
        </div>
      `;
    }

    function setStatus(el, text, ready) {
      el.textContent = text;
      el.classList.toggle("ready", !!ready);
    }

    function formatCount(value) {
      const num = Number(value || 0);
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + "M";
      if (num >= 1_000) return (num / 1_000).toFixed(1) + "K";
      return String(num);
    }

    function formatDate(value) {
      if (!value) return "-";
      try {
        return new Date(value).toISOString().slice(0, 10);
      } catch (error) {
        return "-";
      }
    }

    function renderPager() {
      if (!state.items.length) {
        pagerInfoEl.textContent = "-";
        pagerDotsEl.innerHTML = "";
        return;
      }
      const current = state.items[state.currentIndex];
      pagerInfoEl.textContent = `${current.emoji} ${current.label} Â· ${state.currentIndex + 1}/${state.items.length}`;
      pagerDotsEl.innerHTML = state.items
        .map((_, index) => {
          const active = index === state.currentIndex ? "active" : "";
          return `<button class="pager-dot ${active}" data-index="${index}"></button>`;
        })
        .join("");
      pagerDotsEl.querySelectorAll(".pager-dot").forEach((dot) => {
        dot.addEventListener("click", () => {
          const idx = Number(dot.dataset.index);
          goToPage(idx);
        });
      });
    }

    function renderLanguagePage() {
      const item = state.items[state.currentIndex];
      if (!item) return;

      if (item.error) {
        languagePageEl.innerHTML = `
          <div class="language-page">
            <div class="lang-head">
              <div class="lang-title"><span>${item.emoji}</span>${item.label}</div>
              <span class="tag">YouTube</span>
            </div>
            <div class="error-box">${formatVideoError(item.error)}</div>
          </div>
        `;
        return;
      }

      const videos = item.videos || [];
      const videoBlocks = videos
        .map((video, index) => {
          const comments = video.comments || [];
          return `
            <details ${index < 2 ? "open" : ""}>
              <summary>${index + 1}. ${video.title || "-"}</summary>
              <div class="video-meta">é¢‘é“ï¼š${video.channel || "-"}</div>
              <div class="video-meta">æ’­æ”¾é‡ï¼š${formatCount(video.viewCount)} Â· å‘å¸ƒæ—¶é—´ï¼š${formatDate(video.publishedAt)}</div>
              <div class="comment-list">
                ${comments
                  .map(
                    (comment) => `
                    <div class="comment">
                      <div class="original">${comment.original || ""}</div>
                      <div class="translated">${comment.translated || ""}</div>
                      <div class="likes">ğŸ‘ ${formatCount(comment.likeCount)}</div>
                    </div>
                  `
                  )
                  .join("")}
              </div>
            </details>
          `;
        })
        .join("");

      languagePageEl.innerHTML = `
        <div class="language-page">
          <div class="lang-head">
            <div class="lang-title"><span>${item.emoji}</span>${item.label}</div>
            <span class="tag">YouTube</span>
          </div>
          <div class="lang-meta">é‡‡æ ·è§†é¢‘ ${item.videoCount || videos.length} Â· è¯„è®º ${item.commentCount || 0}</div>
          <div class="module-actions">
            <button class="primary-btn" id="localSummaryBtn">ç”Ÿæˆæœ¬è¯­ç§æ€»ç»“</button>
          </div>
          <div class="summary-panel" id="localSummary"></div>
          <div class="video-list">${videoBlocks}</div>
        </div>
      `;

      const localBtn = document.getElementById("localSummaryBtn");
      const localPanel = document.getElementById("localSummary");
      if (localBtn) {
        localBtn.addEventListener("click", () => handleLocalSummary(item, localPanel));
      }
    }

    async function handleLocalSummary(item, panel) {
      panel.classList.add("active");
      panel.innerHTML = "<p>AI æ­£åœ¨ç”Ÿæˆæœ¬è¯­ç§æ€»ç»“...</p>";

      try {
        const response = await fetch("/api/summary/comments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: state.query, items: [item], scope: "local" }),
        });
        if (!response.ok) throw new Error("Summary failed");
        const data = await response.json();
        showSummary(panel, "æœ¬è¯­ç§æ€»ç»“", data.summary || "æš‚æ— ç»“æœ");
      } catch (error) {
        panel.innerHTML = "<p>æ€»ç»“ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>";
      }
    }

    function showSummary(panel, title, content) {
      panel.innerHTML = `
        <h3>${title}</h3>
        ${content
          .split("\n")
          .filter((line) => line.trim())
          .map((line) => `<p>${line}</p>`)
          .join("")}
      `;
      panel.classList.add("active");
    }

    function goToPage(index) {
      if (index < 0 || index >= state.items.length) return;
      state.currentIndex = index;
      renderPager();
      renderLanguagePage();
    }

    async function startSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        searchInput.focus();
        return;
      }

      state.query = query;
      state.items = [];
      state.currentIndex = 0;

      queryTextEl.textContent = query;
      homeEl.style.display = "none";
      resultsEl.classList.add("active");
      globalSummaryBtn.disabled = true;
      globalSummaryEl.classList.remove("active");
      globalSummaryEl.innerHTML = "";

      renderSkeleton();
      setStatus(videoStatusEl, "æ­£åœ¨æŠ“å–è¯„è®º", false);

      try {
        const response = await fetch("/api/video", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query }),
        });
        if (!response.ok) throw new Error("Request failed");
        const data = await response.json();
        state.items = data.items || [];
        setStatus(videoStatusEl, "è¯„è®ºå·²å°±ç»ª", true);
        globalSummaryBtn.disabled = false;
        renderPager();
        renderLanguagePage();
      } catch (error) {
        setStatus(videoStatusEl, "æŠ“å–å¤±è´¥", false);
      }
    }

    async function handleGlobalSummary() {
      if (!state.items.length) return;
      globalSummaryEl.classList.add("active");
      globalSummaryEl.innerHTML = "<p>AI æ­£åœ¨ç”Ÿæˆå…¨çƒæ€»ç»“...</p>";
      try {
        const response = await fetch("/api/summary/comments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: state.query, items: state.items, scope: "global" }),
        });
        if (!response.ok) throw new Error("Summary failed");
        const data = await response.json();
        showSummary(globalSummaryEl, "å…¨çƒæ€»ç»“", data.summary || "æš‚æ— ç»“æœ");
      } catch (error) {
        globalSummaryEl.innerHTML = "<p>æ€»ç»“ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>";
      }
    }

    function resetSearch() {
      resultsEl.classList.remove("active");
      homeEl.style.display = "grid";
      searchInput.focus();
    }

    function formatVideoError(error) {
      if (!error) return "è§†é¢‘è·å–å¤±è´¥";
      if (error.includes("YouTube API")) {
        return "æœªé…ç½® YouTube API Keyï¼Œæ— æ³•è·å–è¯„è®º";
      }
      if (error.includes("Invidious") || error.includes("403")) {
        return "å…¬å…±æ¥å£è¢«æ‹’ç»è®¿é—®ï¼Œè¯·ç¨åé‡è¯•";
      }
      return "è§†é¢‘è·å–å¤±è´¥";
    }

    document.getElementById("searchBtn").addEventListener("click", startSearch);
    document.getElementById("resetBtn").addEventListener("click", resetSearch);
    document.getElementById("prevLang").addEventListener("click", () => goToPage(state.currentIndex - 1));
    document.getElementById("nextLang").addEventListener("click", () => goToPage(state.currentIndex + 1));
    globalSummaryBtn.addEventListener("click", handleGlobalSummary);

    searchInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        startSearch();
      }
    });
  </script>
</body>
</html>
